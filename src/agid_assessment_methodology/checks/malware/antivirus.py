"""
Antivirus status check implementation.

This module checks if antivirus software is installed, running, and properly configured.
"""

import os
import platform
import subprocess
import logging
from typing import Dict, Any, List, Optional
from datetime import datetime

from ..base import BaseCheck
from ...utils.helpers import run_command, is_windows, is_linux

logger = logging.getLogger(__name__)

class AntivirusCheck(BaseCheck):
    """Check for active antivirus protection on the system."""

    def __init__(self):
        super().__init__()
        self.id = "antivirus"
        self.name = "Antivirus Protection"
        self.description = "Verifies that antivirus software is installed and running"
        self.category = "malware"
        self.severity = "critical"
        self.supported_os = ["windows", "linux", "macos"]

    def execute(self, context: Dict[str, Any]) -> Dict[str, Any]:
        """
        Execute antivirus check based on operating system.

        Args:
            context: Execution context with system information

        Returns:
            CheckResult with antivirus status details
        """
        try:
            os_type = context.get('os_type', platform.system().lower())

            if os_type == 'windows':
                return self._check_windows_antivirus()
            elif os_type == 'linux':
                return self._check_linux_antivirus()
            elif os_type == 'darwin':
                return self._check_macos_antivirus()
            else:
                return self.format_result(
                    "error",
                    {"error": f"Unsupported OS: {os_type}"},
                    "OS not supported for antivirus check"
                )

        except Exception as e:
            logger.error(f"Error in antivirus check: {str(e)}")
            return self.handle_error(e)

    def _check_windows_antivirus(self) -> Dict[str, Any]:
        """Check Windows antivirus status using WMI and PowerShell."""
        details = {
            "products": [],
            "windows_defender": None,
            "active_protection": False,
            "real_time_protection": False
        }

        try:
            # Check Windows Defender status first
            defender_status = self._check_windows_defender()
            if defender_status:
                details["windows_defender"] = defender_status
                details["active_protection"] = defender_status.get("enabled", False)
                details["real_time_protection"] = defender_status.get("real_time_enabled", False)

            # Check third-party antivirus products via WMI
            third_party_av = self._check_third_party_antivirus_windows()
            if third_party_av:
                details["products"].extend(third_party_av)
                # If any third-party AV is active, mark as protected
                if any(av.get("state") == "enabled" for av in third_party_av):
                    details["active_protection"] = True

            # Determine overall status
            if details["active_protection"]:
                status = "pass"
                recommendation = "Antivirus protection is active and properly configured."
            else:
                status = "fail"
                recommendation = "No active antivirus protection found. Install and enable antivirus software."

        except Exception as e:
            logger.error(f"Error checking Windows antivirus: {str(e)}")
            status = "error"
            details["error"] = str(e)
            recommendation = "Unable to check antivirus status due to system error."

        return self.format_result(status, details, recommendation)

    def _check_windows_defender(self) -> Optional[Dict[str, Any]]:
        """Check Windows Defender status using PowerShell."""
        try:
            # PowerShell command to get Windows Defender status
            cmd = [
                "powershell", "-Command",
                "Get-MpComputerStatus | Select-Object AntivirusEnabled, RealTimeProtectionEnabled, "
                "OnAccessProtectionEnabled, NISEnabled, AntivirusSignatureLastUpdated | ConvertTo-Json"
            ]

            result = run_command(cmd, timeout=30)
            if result and result.get("returncode") == 0:
                import json
                defender_info = json.loads(result["stdout"])

                return {
                    "name": "Windows Defender",
                    "enabled": defender_info.get("AntivirusEnabled", False),
                    "real_time_enabled": defender_info.get("RealTimeProtectionEnabled", False),
                    "on_access_protection": defender_info.get("OnAccessProtectionEnabled", False),
                    "nis_enabled": defender_info.get("NISEnabled", False),
                    "last_signature_update": defender_info.get("AntivirusSignatureLastUpdated")
                }
        except Exception as e:
            logger.warning(f"Could not check Windows Defender status: {str(e)}")

        return None

    def _check_third_party_antivirus_windows(self) -> List[Dict[str, Any]]:
        """Check for third-party antivirus products using WMI."""
        products = []

        try:
            # Check AntiVirusProduct WMI class
            cmd = [
                "powershell", "-Command",
                "Get-WmiObject -Namespace 'root\\SecurityCenter2' -Class AntiVirusProduct | "
                "Select-Object displayName, productState, pathToSignedProductExe | ConvertTo-Json"
            ]

            result = run_command(cmd, timeout=30)
            if result and result.get("returncode") == 0 and result["stdout"].strip():
                import json
                av_products = json.loads(result["stdout"])

                # Handle single product vs array
                if isinstance(av_products, dict):
                    av_products = [av_products]

                for product in av_products:
                    # Decode product state (hex value that indicates status)
                    product_state = product.get("productState", 0)

                    products.append({
                        "name": product.get("displayName", "Unknown"),
                        "path": product.get("pathToSignedProductExe", ""),
                        "state": self._decode_av_state(product_state),
                        "raw_state": hex(product_state) if product_state else "0x0"
                    })

        except Exception as e:
            logger.warning(f"Could not check third-party antivirus: {str(e)}")

        return products

    def _decode_av_state(self, state: int) -> str:
        """Decode antivirus product state from hex value."""
        try:
            # Common state values (this is a simplified interpretation)
            # The actual decoding is complex and varies by product
            if state == 0:
                return "disabled"
            elif state & 0x1000:  # Real-time protection enabled
                return "enabled"
            elif state & 0x0010:  # Product enabled
                return "enabled"
            else:
                return "unknown"
        except:
            return "unknown"

    def _check_linux_antivirus(self) -> Dict[str, Any]:
        """Check Linux antivirus status (primarily ClamAV)."""
        details = {
            "products": [],
            "clamav_installed": False,
            "clamav_running": False,
            "clamd_running": False,
            "active_protection": False
        }

        try:
            # Check if ClamAV is installed
            clamav_info = self._check_clamav_linux()
            if clamav_info:
                details.update(clamav_info)
                details["products"].append({
                    "name": "ClamAV",
                    "installed": clamav_info["clamav_installed"],
                    "running": clamav_info["clamav_running"] or clamav_info["clamd_running"]
                })
                details["active_protection"] = clamav_info["clamd_running"]

            # Check for other common Linux antivirus solutions
            other_av = self._check_other_linux_antivirus()
            if other_av:
                details["products"].extend(other_av)
                if any(av.get("running", False) for av in other_av):
                    details["active_protection"] = True

            # Determine status
            if details["active_protection"]:
                status = "pass"
                recommendation = "Antivirus protection is active."
            elif details["products"]:
                status = "warning"
                recommendation = "Antivirus software is installed but may not be running. Check service status."
            else:
                status = "fail"
                recommendation = "No antivirus software detected. Consider installing ClamAV or other antivirus solution."

        except Exception as e:
            logger.error(f"Error checking Linux antivirus: {str(e)}")
            status = "error"
            details["error"] = str(e)
            recommendation = "Unable to check antivirus status due to system error."

        return self.format_result(status, details, recommendation)

    def _check_clamav_linux(self) -> Optional[Dict[str, Any]]:
        """Check ClamAV installation and status on Linux."""
        clamav_info = {
            "clamav_installed": False,
            "clamav_running": False,
            "clamd_running": False,
            "version": None
        }

        try:
            # Check if clamscan is installed
            result = run_command(["which", "clamscan"], timeout=10)
            if result and result.get("returncode") == 0:
                clamav_info["clamav_installed"] = True

                # Get ClamAV version
                version_result = run_command(["clamscan", "--version"], timeout=10)
                if version_result and version_result.get("returncode") == 0:
                    clamav_info["version"] = version_result["stdout"].strip()

            # Check if clamd daemon is running
            daemon_result = run_command(["pgrep", "-x", "clamd"], timeout=10)
            if daemon_result and daemon_result.get("returncode") == 0:
                clamav_info["clamd_running"] = True

            # Alternative check for clamd service
            service_result = run_command(["systemctl", "is-active", "clamav-daemon"], timeout=10)
            if service_result and service_result.get("returncode") == 0:
                if "active" in service_result["stdout"]:
                    clamav_info["clamd_running"] = True

        except Exception as e:
            logger.warning(f"Error checking ClamAV: {str(e)}")

        return clamav_info if clamav_info["clamav_installed"] else None

    def _check_other_linux_antivirus(self) -> List[Dict[str, Any]]:
        """Check for other Linux antivirus solutions."""
        products = []

        # List of common Linux antivirus solutions to check
        av_solutions = [
            {"name": "Sophos", "process": "savd", "command": "savscan"},
            {"name": "ESET", "process": "esets_daemon", "command": "esets_scan"},
            {"name": "Bitdefender", "process": "bdsec", "command": "bdscan"},
            {"name": "Kaspersky", "process": "kesl", "command": "kesl-control"},
            {"name": "F-Secure", "process": "fsav", "command": "fsav"}
        ]

        for av in av_solutions:
            try:
                # Check if process is running
                proc_result = run_command(["pgrep", "-x", av["process"]], timeout=10)
                process_running = proc_result and proc_result.get("returncode") == 0

                # Check if command exists
                cmd_result = run_command(["which", av["command"]], timeout=10)
                command_exists = cmd_result and cmd_result.get("returncode") == 0

                if process_running or command_exists:
                    products.append({
                        "name": av["name"],
                        "running": process_running,
                        "installed": command_exists
                    })

            except Exception as e:
                logger.debug(f"Error checking {av['name']}: {str(e)}")

        return products

    def _check_macos_antivirus(self) -> Dict[str, Any]:
        """Check macOS antivirus status."""
        details = {
            "products": [],
            "xprotect_enabled": False,
            "active_protection": False
        }

        try:
            # Check XProtect (built-in macOS antivirus)
            xprotect_info = self._check_xprotect_macos()
            if xprotect_info:
                details["xprotect_enabled"] = xprotect_info.get("enabled", False)
                details["products"].append({
                    "name": "XProtect",
                    "enabled": xprotect_info.get("enabled", False),
                    "version": xprotect_info.get("version")
                })
                details["active_protection"] = xprotect_info.get("enabled", False)

            # Check for third-party macOS antivirus
            third_party_av = self._check_third_party_antivirus_macos()
            if third_party_av:
                details["products"].extend(third_party_av)
                if any(av.get("running", False) for av in third_party_av):
                    details["active_protection"] = True

            # Determine status
            if details["active_protection"]:
                status = "pass"
                recommendation = "Antivirus protection is active."
            else:
                status = "warning"
                recommendation = "Limited antivirus protection. Consider installing additional antivirus software."

        except Exception as e:
            logger.error(f"Error checking macOS antivirus: {str(e)}")
            status = "error"
            details["error"] = str(e)
            recommendation = "Unable to check antivirus status due to system error."

        return self.format_result(status, details, recommendation)

    def _check_xprotect_macos(self) -> Optional[Dict[str, Any]]:
        """Check XProtect status on macOS."""
        try:
            # Check if XProtect is enabled
            result = run_command(["defaults", "read", "com.apple.security", "XProtect-Enable"], timeout=10)
            if result and result.get("returncode") == 0:
                enabled = "1" in result["stdout"] or "true" in result["stdout"].lower()

                return {
                    "enabled": enabled,
                    "version": self._get_xprotect_version()
                }
        except Exception as e:
            logger.warning(f"Could not check XProtect status: {str(e)}")

        return None

    def _get_xprotect_version(self) -> Optional[str]:
        """Get XProtect version."""
        try:
            result = run_command(["system_profiler", "SPInstallHistoryDataType"], timeout=20)
            if result and result.get("returncode") == 0:
                lines = result["stdout"].split('\n')
                for line in lines:
                    if "XProtect" in line and "Version" in line:
                        return line.split("Version: ")[-1].strip()
        except Exception as e:
            logger.debug(f"Could not get XProtect version: {str(e)}")

        return None

    def _check_third_party_antivirus_macos(self) -> List[Dict[str, Any]]:
        """Check for third-party antivirus on macOS."""
        products = []

        # Common macOS antivirus solutions
        av_solutions = [
            {"name": "Norton", "process": "Norton", "path": "/Applications/Norton Security.app"},
            {"name": "McAfee", "process": "McAfee", "path": "/Applications/McAfee Security.app"},
            {"name": "Bitdefender", "process": "Bitdefender", "path": "/Applications/Bitdefender Antivirus.app"},
            {"name": "Kaspersky", "process": "Kaspersky", "path": "/Applications/Kaspersky Security Cloud.app"},
            {"name": "Sophos", "process": "Sophos", "path": "/Applications/Sophos Home.app"}
        ]

        for av in av_solutions:
            try:
                # Check if application is installed
                installed = os.path.exists(av["path"])

                # Check if process is running
                proc_result = run_command(["pgrep", "-i", av["process"]], timeout=10)
                running = proc_result and proc_result.get("returncode") == 0

                if installed or running:
                    products.append({
                        "name": av["name"],
                        "installed": installed,
                        "running": running
                    })

            except Exception as e:
                logger.debug(f"Error checking {av['name']}: {str(e)}")

        return products